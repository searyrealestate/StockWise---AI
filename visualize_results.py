"""
Backtest Results Visualizer
===========================

This script automatically finds and visualizes the results from the system
performance backtests. It generates three key charts to compare the performance
of the different AI trading agents, providing a clear, high-level overview of
their effectiveness.

The script is designed to be run after the `test_system_performance.py` backtester,
as it reads the CSV output files generated by that process.

Charts Generated:
-----------------
1.  Equity Curve Comparison: A line chart that plots the normalized portfolio
    growth over time for each agent. All curves start at a value of 1.0, making
    it easy to compare the relative performance and volatility of each strategy.

2.  Sharpe Ratio Comparison: A bar chart comparing the Sharpe Ratio (a measure of
    risk-adjusted return) for each agent's overall performance. It includes a
    red line indicating the target KPI.

3.  Max Drawdown Comparison: A bar chart comparing the Maximum Drawdown (the largest
    peak-to-trough loss) for each agent during the bear market stress test. It
    also includes a red line for the target KPI.

All generated charts are saved as PNG image files in the 'backtest_results/'
directory.

Usage:
------
    python visualize_results.py

"""
# visualize_results.py

import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import glob
import os


def plot_equity_curves():
    """Finds all 'Overall' equity curve CSVs and plots them for comparison."""
    results_dir = "backtest_results"
    equity_files = glob.glob(os.path.join(results_dir, 'equity_curve_*Overall*.csv'))

    if not equity_files:
        print("No equity curve CSV files found.")
        return

    plt.figure(figsize=(14, 8))
    for file in equity_files:
        # Extract agent name from filename, e.g., 'equity_curve_dynamic_Overall.csv' -> 'dynamic'
        agent_name = os.path.basename(file).split('_')[2]
        df = pd.read_csv(file, index_col=0, parse_dates=True)
        # Normalize the starting value to 1 to compare percentage growth
        normalized_equity = df['portfolio_value'] / df['portfolio_value'].iloc[0]
        plt.plot(df.index, normalized_equity, label=f'{agent_name.capitalize()} Agent')

    plt.title('Normalized Equity Curve Comparison (Overall Performance)', fontsize=16)
    plt.xlabel('Date')
    plt.ylabel('Normalized Portfolio Value (Growth)')
    plt.legend()
    plt.grid(True)
    equity_path = os.path.join(results_dir, "equity_curve_comparison.png")
    plt.savefig(equity_path)
    print(f"âœ… Equity Curve comparison chart saved to: {equity_path}")
    plt.close()


def visualize_latest_backtest_results():
    """Finds the latest backtest summary and generates comparison charts."""
    # Find the most recent backtest summary file
    results_dir = "backtest_results"
    list_of_files = glob.glob(os.path.join(results_dir, 'backtest_summary_*.csv'))
    if not list_of_files:
        print("No backtest summary CSV files found. Please run the tests first.")
        return

    latest_file = max(list_of_files, key=os.path.getctime)
    print(f"ðŸ“Š Visualizing results from: {latest_file}")
    df = pd.read_csv(latest_file)

    # --- Create Bar Charts for Key Metrics ---
    sns.set_theme(style="whitegrid")

    # Filter for Overall Performance
    overall_df = df[df['test_type'] == 'Overall'].sort_values('Sharpe Ratio', ascending=False)

    # 1. Sharpe Ratio Comparison
    plt.figure(figsize=(10, 6))
    sns.barplot(data=overall_df, x='agent', y='Sharpe Ratio', palette='viridis')
    plt.title('Sharpe Ratio Comparison (Overall Performance)', fontsize=16)
    plt.axhline(y=1.0, color='r', linestyle='--', label='Target KPI (1.0)')
    plt.legend()
    sharpe_path = os.path.join(results_dir, "sharpe_ratio_comparison.png")
    plt.savefig(sharpe_path)
    print(f"âœ… Sharpe Ratio chart saved to: {sharpe_path}")
    plt.close()

    # 2. Max Drawdown Comparison
    stress_df = df[df['test_type'] == 'Stress Test (Bear Market)'].sort_values('Max Drawdown')
    plt.figure(figsize=(10, 6))
    sns.barplot(data=stress_df, x='agent', y='Max Drawdown', palette='plasma')
    plt.title('Max Drawdown Comparison (Bear Market Stress Test)', fontsize=16)
    plt.axhline(y=25.0, color='r', linestyle='--', label='Target KPI (< 25%)')
    plt.legend()
    drawdown_path = os.path.join(results_dir, "max_drawdown_comparison.png")
    plt.savefig(drawdown_path)
    print(f"âœ… Max Drawdown chart saved to: {drawdown_path}")
    plt.close()


if __name__ == "__main__":
    visualize_latest_backtest_results()
    plot_equity_curves()